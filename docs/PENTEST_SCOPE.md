# Penetration Testing Scope & Preparation

This document defines the scope, test environment setup, and remediation process for an external penetration test of the Dead Drop secure file exchange system.

**Related Documents:**
- [Security Audit](../SECURITY_AUDIT.md) — 32 findings from prior audit
- [Threat Model](THREAT_MODEL.md)
- [Architecture](ARCHITECTURE.md)
- [Key Management](KEY_MANAGEMENT.md)
- [Incident Response](INCIDENT_RESPONSE.md)
- [Deployment Guide](DEPLOYMENT_GUIDE.md)

---

## 1. Scope & Rules of Engagement

### 1.1 In-Scope Targets

#### HTTP Endpoints

| Method | Path | Description |
|--------|------|-------------|
| GET | `/` | Index / service info |
| POST | `/submit` | Submit an encrypted drop |
| GET | `/retrieve` | Retrieve a drop by receipt |
| GET | `/metrics` | Prometheus metrics (optional, may be localhost-only) |

#### Cryptographic Subsystems
- **AES-256-GCM** envelope encryption of drop payloads
- **HMAC-SHA256** receipt generation and verification
- **Argon2id** key derivation from master key
- **HKDF** per-drop key derivation
- Nonce generation and uniqueness guarantees

#### Transport Security
- TLS configuration (cipher suites, protocol versions, certificate handling)
- Tor hidden service mode (`security.tor_only`)
- Timing jitter implementation (anti-timing-analysis)

#### Storage & File Handling
- Drop storage directory structure and permissions
- Key file protection
- Secure deletion (`security.secure_delete`) — overwrite-before-remove behavior
- File type blocking and upload size limits (`server.max_upload_mb`)
- Storage quotas (`security.max_storage_gb`, `security.max_drops`)
- Drop expiration and garbage collection (`security.max_age_hours`)

#### Access Controls & Anti-Abuse
- Rate limiting (`security.rate_limit_per_min`)
- Drop ID format validation (regex-based anti-enumeration)
- CSRF header requirement on `POST /submit`
- Security headers middleware
- Honeypot drops (`security.honeypots_enabled`, `security.honeypot_count`)
- Alert webhook integration (`security.alert_webhook`)

#### Operational
- Metrics endpoint access control (`server.metrics.localhost_only`)
- Logging behavior and information disclosure (`logging.*`)
- Error message content
- Metadata scrubbing (`security.scrub_metadata`)
- Key rotation (`dead-drop-rotate-keys` binary)

### 1.2 Out of Scope

- **Operating system and kernel** — Host OS hardening is outside this engagement
- **Tor network infrastructure** — Attacks against the Tor protocol itself
- **Go standard library and crypto primitives** — Assume `crypto/*` packages are correct; focus on *usage*
- **Physical access and social engineering**
- **Third-party dependencies** — Unless a known CVE is exploitable through Dead Drop's usage
- **Denial of service against production** — See Rules of Engagement below

### 1.3 Rules of Engagement

1. **Test environment only** — All testing MUST use the dedicated test instance (see Section 2). No testing against production systems.
2. **No denial of service** — Do not attempt to exhaust resources or crash the test server beyond what is needed to demonstrate a finding.
3. **No real drop exfiltration** — Test drops only. Do not attempt to access or exfiltrate any real user data if a shared environment is used.
4. **Coordinated disclosure** — All findings must be reported through the agreed-upon channel before any public disclosure. Follow the timeline in our [Incident Response](INCIDENT_RESPONSE.md) policy.
5. **Scope boundaries** — If you discover a path that leads out of scope (e.g., OS-level vulnerability), document it and stop. Do not exploit further without written authorization.
6. **Logging** — The test environment will have `logging.operations: true` enabled. Testers should keep their own logs for correlation.

### 1.4 Reporting Requirements

Each finding must include:

| Field | Description |
|-------|-------------|
| **Finding ID** | Sequential (e.g., PT-001) |
| **Title** | Brief description |
| **Severity** | CVSS v3.1 base score and qualitative rating (Critical/High/Medium/Low/Info) |
| **Affected Component** | Endpoint, function, or subsystem |
| **Description** | Technical explanation of the vulnerability |
| **Proof of Concept** | Steps to reproduce, including commands or scripts |
| **Impact** | What an attacker can achieve |
| **Remediation** | Suggested fix |

### 1.5 Prior Findings

The [Security Audit](../SECURITY_AUDIT.md) identified 32 findings across these categories:

| Category | Count |
|----------|-------|
| Critical | 7 |
| High | 8 |
| Medium | 5 |
| Low | 3 |
| Forensic Concerns | 3 |
| Operational Security | 4 |

Most critical and high findings have been remediated. Testers should verify that prior remediations are effective and check for regressions. The full audit report is available for review.

---

## 2. Test Environment Setup

### 2.1 Build from Source

```bash
git clone <repo-url> dead-drop
cd dead-drop
make build-production
```

This produces hardened binaries with stripped symbols and `-trimpath`:
- `dead-drop-server`
- `dead-drop-submit`
- `dead-drop-rotate-keys`

### 2.2 Generate Self-Signed TLS Certificate

```bash
openssl req -x509 -newkey ec -pkeyopt ec_paramgen_curve:P-256 \
  -keyout test-key.pem -out test-cert.pem -days 30 -nodes \
  -subj "/CN=dead-drop-pentest"
```

### 2.3 Sample Configuration

Create `config.yaml` with all security features enabled for comprehensive testing:

```yaml
server:
  listen: "127.0.0.1:8443"
  storage_dir: "./test-drops"
  max_upload_mb: 10
  tls:
    cert_file: "test-cert.pem"
    key_file: "test-key.pem"
  metrics:
    enabled: true
    localhost_only: false  # Allow pentest access to metrics

security:
  delete_after_retrieve: true
  max_age_hours: 24
  scrub_metadata: true
  rate_limit_per_min: 60  # Higher limit for testing throughput
  secure_delete: true
  max_storage_gb: 1
  max_drops: 100
  master_key_env: "DEAD_DROP_MASTER_KEY"
  honeypots_enabled: true
  honeypot_count: 5
  alert_webhook: ""  # Set to a webhook URL to test alerting
  tor_only: false    # Set to true for Tor-specific testing

logging:
  startup: true
  errors: true
  operations: true
  log_dir: "./test-logs"
```

### 2.4 Start the Test Server

```bash
export DEAD_DROP_MASTER_KEY="$(openssl rand -hex 32)"
./dead-drop-server -config config.yaml
```

### 2.5 Seed Test Drops

Use the CLI to create test drops for retrieval testing:

```bash
# Submit a text file
echo "pentest sample payload" > test-payload.txt
./dead-drop-submit -server https://127.0.0.1:8443 -file test-payload.txt -insecure

# Submit a larger binary file
dd if=/dev/urandom of=test-binary.bin bs=1024 count=512
./dead-drop-submit -server https://127.0.0.1:8443 -file test-binary.bin -insecure
```

Save the receipts returned by the submit command for retrieval testing.

### 2.6 Tor Hidden Service Testing (Optional)

To test the Tor-only mode:

1. Install Tor and configure a hidden service pointing to the server's listen address
2. Set `security.tor_only: true` in `config.yaml`
3. Access the server exclusively through the `.onion` address
4. Verify that non-Tor connections are rejected

### 2.7 Recommended Tools

- **Burp Suite** or **OWASP ZAP** — HTTP interception and fuzzing
- **curl** / **httpie** — Manual endpoint testing
- **testssl.sh** — TLS configuration analysis
- **Custom scripts** — Receipt brute-force attempts, timing analysis, race condition testing
- **Wireshark** — Traffic analysis (verify TLS, check for leaks)
- **gobuster** / **ffuf** — Path enumeration (verify no hidden endpoints)

---

## 3. Remediation Timeline Template

### 3.1 Service Level Agreements

| Severity | Target Resolution | Description |
|----------|-------------------|-------------|
| **Critical** (CVSS 9.0-10.0) | 48 hours | Remote code execution, authentication bypass, key material exposure |
| **High** (CVSS 7.0-8.9) | 7 days | Data exfiltration, significant confidentiality breach, crypto weakness |
| **Medium** (CVSS 4.0-6.9) | 30 days | Information disclosure, limited impact vulnerabilities |
| **Low** (CVSS 0.1-3.9) | 90 days | Minor issues, defense-in-depth improvements |
| **Informational** | Best effort | Hardening suggestions, code quality observations |

### 3.2 Finding Tracker

| ID | Severity | CVSS | Description | Component | Owner | Target Date | Status |
|----|----------|------|-------------|-----------|-------|-------------|--------|
| PT-001 | | | | | | | Open |
| PT-002 | | | | | | | Open |
| PT-003 | | | | | | | Open |

**Status values:** Open, In Progress, Resolved, Verified, Won't Fix, Accepted Risk

### 3.3 Retest & Verification Procedure

1. **Fix implemented** — Developer resolves the finding and updates the tracker status to "Resolved"
2. **Retest requested** — Project lead notifies the pentest team that a fix is ready for verification
3. **Retest performed** — Pentester re-executes the original PoC against the patched build
4. **Verified or reopened** — If the fix is effective, status moves to "Verified". If the issue persists or a bypass is found, status reverts to "Open" with updated notes
5. **Final report** — After all findings are addressed, the pentest team issues a retest summary confirming the final state of each finding
